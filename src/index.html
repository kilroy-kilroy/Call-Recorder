<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';" />
  <title>Call Recorder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0f0f13;
      --surface: #1a1a24;
      --surface-hover: #22222f;
      --border: #2a2a3a;
      --text: #e4e4ed;
      --text-dim: #8888a0;
      --accent: #6c5ce7;
      --accent-hover: #7d6ff0;
      --red: #e74c5c;
      --red-hover: #f05c6c;
      --green: #2ecc71;
      --yellow: #f1c40f;
      --radius: 10px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      -webkit-app-region: drag;
    }

    button, input, select, a { -webkit-app-region: no-drag; }

    /* --- Titlebar --- */
    .titlebar {
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      flex-shrink: 0;
      letter-spacing: 0.3px;
    }

    /* --- Tabs --- */
    .tabs {
      display: flex;
      gap: 2px;
      padding: 0 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .tab {
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-dim);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* --- Content --- */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }
    .panel { display: none; }
    .panel.active { display: block; }

    /* --- Record panel --- */
    .record-form {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }
    .record-form input {
      flex: 1;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
    }
    .record-form input:focus { border-color: var(--accent); }
    .record-form input::placeholder { color: var(--text-dim); }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background: var(--red); color: #fff; }
    .btn-danger:hover { background: var(--red-hover); }
    .btn-sm { padding: 6px 14px; font-size: 12px; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover { background: var(--surface-hover); border-color: var(--text-dim); }

    /* --- Bot cards --- */
    .bot-list { display: flex; flex-direction: column; gap: 10px; }

    .bot-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: background 0.15s;
    }
    .bot-card:hover { background: var(--surface-hover); }

    .bot-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .bot-status-dot.joining { background: var(--yellow); }
    .bot-status-dot.in_call_recording { background: var(--red); animation: pulse 1.5s infinite; }
    .bot-status-dot.in_call_not_recording { background: var(--green); }
    .bot-status-dot.done { background: var(--text-dim); }
    .bot-status-dot.fatal { background: var(--red); }
    .bot-status-dot.unknown { background: var(--text-dim); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .bot-info { flex: 1; min-width: 0; }
    .bot-name { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .bot-meta {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .bot-actions { display: flex; gap: 6px; flex-shrink: 0; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }
    .empty-state h3 {
      font-size: 16px;
      color: var(--text);
      margin-bottom: 8px;
    }
    .empty-state p { font-size: 13px; }

    /* --- Settings --- */
    .settings-form { max-width: 480px; }
    .field { margin-bottom: 20px; }
    .field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .field input, .field select {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    .field input:focus, .field select:focus { border-color: var(--accent); }
    .field select option { background: var(--surface); }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 20px;
      font-size: 13px;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { border-color: var(--red); }
    .toast.success { border-color: var(--green); }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
  </style>
</head>
<body>
  <div class="titlebar">Call Recorder</div>

  <div class="tabs">
    <button class="tab active" data-tab="record">Record</button>
    <button class="tab" data-tab="recordings">Recordings</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <!-- RECORD -->
  <div class="content">
    <div class="panel active" id="panel-record">
      <div class="record-form">
        <input type="text" id="meeting-url" placeholder="Paste a meeting link (Zoom, Meet, Teams...)" />
        <input type="text" id="bot-name" placeholder="Bot name (optional)" style="max-width:180px" />
        <button class="btn btn-primary" id="btn-record">Record</button>
      </div>
      <div id="active-bots" class="bot-list"></div>
      <div id="empty-active" class="empty-state">
        <h3>No active recordings</h3>
        <p>Paste a meeting link above and click Record to get started.</p>
      </div>
    </div>

    <!-- RECORDINGS -->
    <div class="panel" id="panel-recordings">
      <div id="completed-bots" class="bot-list"></div>
      <div id="empty-completed" class="empty-state">
        <h3>No recordings yet</h3>
        <p>Completed recordings will appear here.</p>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="panel" id="panel-settings">
      <div class="settings-form">
        <div class="field">
          <label>Recall.ai API Key</label>
          <input type="password" id="setting-api-key" placeholder="Enter your API key" />
        </div>
        <div class="field">
          <label>Region</label>
          <select id="setting-region">
            <option value="us-west-2">US West (us-west-2) â€” Pay-as-you-go</option>
            <option value="us-east-1">US East (us-east-1)</option>
            <option value="eu-central-1">EU (eu-central-1)</option>
            <option value="ap-northeast-1">Japan (ap-northeast-1)</option>
          </select>
        </div>
        <div class="field">
          <label>Default Bot Name</label>
          <input type="text" id="setting-bot-name" placeholder="Call Recorder" />
        </div>
        <button class="btn btn-primary" id="btn-save-settings">Save Settings</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --- State ---
    const activeBots = new Map(); // id -> bot data
    let pollInterval = null;

    // --- Tabs ---
    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".panel").forEach((p) => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`panel-${tab.dataset.tab}`).classList.add("active");
        if (tab.dataset.tab === "recordings") loadCompletedBots();
        if (tab.dataset.tab === "settings") loadSettings();
      });
    });

    // --- Toast ---
    function showToast(msg, type = "") {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = `toast show ${type}`;
      setTimeout(() => (t.className = "toast"), 3000);
    }

    // --- Settings ---
    async function loadSettings() {
      const s = await window.api.getSettings();
      document.getElementById("setting-api-key").value = s.apiKey || "";
      document.getElementById("setting-region").value = s.region || "us-west-2";
      document.getElementById("setting-bot-name").value = s.botName || "Call Recorder";
    }

    document.getElementById("btn-save-settings").addEventListener("click", async () => {
      const settings = {
        apiKey: document.getElementById("setting-api-key").value.trim(),
        region: document.getElementById("setting-region").value,
        botName: document.getElementById("setting-bot-name").value.trim() || "Call Recorder",
      };
      await window.api.saveSettings(settings);
      showToast("Settings saved", "success");
    });

    // --- Record ---
    document.getElementById("btn-record").addEventListener("click", async () => {
      const url = document.getElementById("meeting-url").value.trim();
      if (!url) return showToast("Please enter a meeting URL", "error");

      const name = document.getElementById("bot-name").value.trim();
      const btn = document.getElementById("btn-record");
      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const bot = await window.api.createBot(url, name || undefined);
        activeBots.set(bot.id, bot);
        document.getElementById("meeting-url").value = "";
        document.getElementById("bot-name").value = "";
        renderActiveBots();
        startPolling();
        showToast("Bot sent to meeting", "success");
      } catch (err) {
        showToast(err.message || "Failed to create bot", "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Record";
      }
    });

    // Allow Enter to submit
    document.getElementById("meeting-url").addEventListener("keydown", (e) => {
      if (e.key === "Enter") document.getElementById("btn-record").click();
    });

    // --- Polling ---
    function startPolling() {
      if (pollInterval) return;
      pollInterval = setInterval(pollActiveBots, 3000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    async function pollActiveBots() {
      const doneIds = [];
      for (const [id] of activeBots) {
        try {
          const bot = await window.api.getBot(id);
          const status = getStatus(bot);
          if (status === "done" || status === "fatal") {
            doneIds.push(id);
          }
          activeBots.set(id, bot);
        } catch {
          // keep polling
        }
      }

      renderActiveBots();

      for (const id of doneIds) {
        activeBots.delete(id);
      }
      renderActiveBots();

      if (activeBots.size === 0) stopPolling();
    }

    // --- Render ---
    function getStatus(bot) {
      if (!bot.status_changes || bot.status_changes.length === 0) return "unknown";
      return bot.status_changes[bot.status_changes.length - 1].code || "unknown";
    }

    function statusLabel(code) {
      const labels = {
        ready: "Ready",
        joining_call: "Joining...",
        in_waiting_room: "In waiting room",
        in_call_not_recording: "In call",
        in_call_recording: "Recording",
        call_ended: "Call ended",
        done: "Done",
        fatal: "Error",
        analysis_done: "Processing done",
      };
      return labels[code] || code;
    }

    function renderActiveBots() {
      const container = document.getElementById("active-bots");
      const empty = document.getElementById("empty-active");

      if (activeBots.size === 0) {
        container.innerHTML = "";
        empty.style.display = "";
        return;
      }

      empty.style.display = "none";
      container.innerHTML = "";

      for (const [id, bot] of activeBots) {
        const status = getStatus(bot);
        const dotClass = status.startsWith("in_call") ? status :
                         status.includes("join") || status === "in_waiting_room" ? "joining" :
                         status === "done" || status === "analysis_done" ? "done" :
                         status === "fatal" ? "fatal" : "unknown";
        const card = document.createElement("div");
        card.className = "bot-card";
        card.innerHTML = `
          <div class="bot-status-dot ${dotClass}"></div>
          <div class="bot-info">
            <div class="bot-name">${esc(bot.bot_name || "Bot")}</div>
            <div class="bot-meta">
              <span>${statusLabel(status)}</span>
              <span>${esc(bot.meeting_url || "").substring(0, 50)}</span>
            </div>
          </div>
          <div class="bot-actions">
            ${status.startsWith("in_call") ? `<button class="btn btn-sm btn-danger" onclick="leaveCall('${id}')">Stop</button>` : ""}
          </div>
        `;
        container.appendChild(card);
      }
    }

    async function leaveCall(botId) {
      try {
        await window.api.leaveMeeting(botId);
        showToast("Bot leaving call...", "success");
      } catch (err) {
        showToast(err.message || "Failed to leave call", "error");
      }
    }
    window.leaveCall = leaveCall;

    // --- Completed recordings ---
    async function loadCompletedBots() {
      const container = document.getElementById("completed-bots");
      const empty = document.getElementById("empty-completed");

      try {
        const data = await window.api.listBots();
        const bots = (data.results || []).filter((b) => {
          const s = getStatus(b);
          return s === "done" || s === "analysis_done";
        });

        if (bots.length === 0) {
          container.innerHTML = "";
          empty.style.display = "";
          return;
        }

        empty.style.display = "none";
        container.innerHTML = "";

        for (const bot of bots) {
          const hasRecording = bot.recordings && bot.recordings.length > 0 &&
            bot.recordings[0].media_shortcuts &&
            bot.recordings[0].media_shortcuts.video_mixed;

          const card = document.createElement("div");
          card.className = "bot-card";
          card.innerHTML = `
            <div class="bot-status-dot done"></div>
            <div class="bot-info">
              <div class="bot-name">${esc(bot.bot_name || "Bot")}</div>
              <div class="bot-meta">
                <span>${new Date(bot.status_changes[0].created_at).toLocaleString()}</span>
                <span>${esc(bot.meeting_url || "").substring(0, 50)}</span>
              </div>
            </div>
            <div class="bot-actions">
              ${hasRecording ? `<button class="btn btn-sm btn-primary" onclick="downloadRec('${bot.recordings[0].media_shortcuts.video_mixed.data.download_url}', '${bot.id}')">Download</button>` : ""}
            </div>
          `;
          container.appendChild(card);
        }
      } catch (err) {
        showToast(err.message || "Failed to load recordings", "error");
      }
    }

    async function downloadRec(url, botId) {
      try {
        const result = await window.api.downloadRecording(url, botId);
        if (result && result.success) showToast("Recording saved!", "success");
      } catch (err) {
        showToast("Download failed", "error");
      }
    }
    window.downloadRec = downloadRec;

    function esc(str) {
      const el = document.createElement("span");
      el.textContent = str;
      return el.innerHTML;
    }

    // --- Init: load settings and pre-populate API key ---
    (async () => {
      const s = await window.api.getSettings();
      if (!s.apiKey) {
        // Switch to settings tab if no API key
        document.querySelectorAll(".tab")[2].click();
        showToast("Please configure your Recall.ai API key to get started", "");
      }
    })();
  </script>
</body>
</html>
